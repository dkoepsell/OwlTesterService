<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BVSS Visualization - {{ filename }}</title>
    <link href="https://cdn.replit.com/agent/bootstrap-agent-dark-theme.min.css" rel="stylesheet">
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        .bvss-container {
            background: #1a1a1a;
            border-radius: 8px;
            margin: 20px 0;
        }
        .bvss-svg {
            width: 100%;
            height: 600px;
            background: #2d2d2d;
            border-radius: 8px;
        }
        .bvss-legend {
            background: #333;
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
        }
        .legend-item {
            display: inline-block;
            margin: 5px 10px;
            font-size: 12px;
        }
        .controls {
            text-align: center;
            margin: 10px 0;
        }
        .btn-sm {
            margin: 0 5px;
        }
    </style>
</head>
<body>
    <div class="container">
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="/">Home</a></li>
                <li class="breadcrumb-item"><a href="/history">History</a></li>
                <li class="breadcrumb-item"><a href="/analyze/{{ filename }}">{{ filename }}</a></li>
                <li class="breadcrumb-item active">BVSS Visualization</li>
            </ol>
        </nav>

        <h2>BVSS Visualization: {{ filename }}</h2>
        <p class="text-muted">Barwise Visual Symbol System for BFO Ontology Visualization</p>

        <div class="row">
            <div class="col-md-3">
                <div class="card">
                    <div class="card-header">Statistics</div>
                    <div class="card-body">
                        <p>Classes: <span id="class-count" class="text-info">0</span></p>
                        <p>Properties: <span id="property-count" class="text-info">0</span></p>
                    </div>
                </div>
            </div>
            <div class="col-md-9">
                <div class="controls">
                    <button class="btn btn-sm btn-secondary" onclick="resetView()">Reset View</button>
                    <button class="btn btn-sm btn-secondary" onclick="centerGraph()">Center</button>
                </div>
                
                <div class="bvss-container">
                    <svg id="bvss-svg" class="bvss-svg"></svg>
                </div>
            </div>
        </div>

        <div class="bvss-legend">
            <h6>BVSS Entity Types</h6>
            <div class="legend-item">● Independent Continuant</div>
            <div class="legend-item">■ Material Entity</div>
            <div class="legend-item">□ Immaterial Entity</div>
            <div class="legend-item">⬛ Object Aggregate</div>
            <div class="legend-item">◌ Dependent Continuant</div>
            <div class="legend-item">⟶ Process</div>
            <div class="legend-item">◬ Spatiotemporal Region</div>
            
            <h6 class="mt-3">BVSS Relations</h6>
            <div class="legend-item">— is_a</div>
            <div class="legend-item">--> part_of</div>
            <div class="legend-item">==> participates_in</div>
            <div class="legend-item">..> inheres_in</div>
        </div>
    </div>

    <script>
        let simulation, svg, g, zoom;

        // BVSS symbol mapping based on BFO classification
        const bvssSymbols = {
            'Independent Continuant': '●',
            'Material Entity': '■',
            'Immaterial Entity': '□',
            'Object Aggregate': '⬛',
            'Fiat Object Part': '▭',
            'Dependent Continuant': '◌',
            'Specifically Dependent': '◌+',
            'Generically Dependent': '◌↺',
            'Quality': '◦',
            'Function': '⚒',
            'Disposition': '⚒',
            'Process': '⟶',
            'Process Aggregate': '⟶⟶',
            'Spatiotemporal Region': '◬',
            'Temporal Instant': '|',
            'default': '○'
        };

        // Color mapping for different BFO types
        const bvssColors = {
            'Independent Continuant': '#4CAF50',
            'Material Entity': '#757575',
            'Immaterial Entity': '#E0E0E0',
            'Object Aggregate': '#424242',
            'Fiat Object Part': '#8BC34A',
            'Dependent Continuant': '#FF9800',
            'Specifically Dependent': '#FF9800',
            'Generically Dependent': '#FFC107',
            'Quality': '#9C27B0',
            'Function': '#673AB7',
            'Disposition': '#673AB7',
            'Process': '#2196F3',
            'Process Aggregate': '#1976D2',
            'Spatiotemporal Region': '#00BCD4',
            'Temporal Instant': '#009688',
            'default': '#666666'
        };

        function classifyBFOType(className) {
            const name = className.toLowerCase();
            
            // Legal ontology specific classifications
            if (name.includes('evidence') || name.includes('document') || name.includes('contract')) {
                return 'Material Entity';
            }
            if (name.includes('role') || name.includes('right') || name.includes('claim')) {
                return 'Specifically Dependent';
            }
            if (name.includes('statute') || name.includes('law') || name.includes('rule')) {
                return 'Generically Dependent';
            }
            if (name.includes('trial') || name.includes('adjudication') || name.includes('process')) {
                return 'Process';
            }
            if (name.includes('jurisdiction') || name.includes('authority') || name.includes('entity')) {
                return 'Independent Continuant';
            }
            if (name.includes('fact') || name.includes('quality')) {
                return 'Quality';
            }
            
            return 'Independent Continuant'; // default
        }

        function initializeVisualization() {
            svg = d3.select("#bvss-svg");
            const width = 800;
            const height = 600;
            
            svg.attr("width", width).attr("height", height);
            
            zoom = d3.zoom()
                .scaleExtent([0.1, 4])
                .on("zoom", (event) => {
                    g.attr("transform", event.transform);
                });
            
            svg.call(zoom);
            
            g = svg.append("g");
            
            // Load and display the ontology data
            loadBVSSData();
        }

        function loadBVSSData() {
            fetch(`/api/bvss/{{ filename }}`)
                .then(response => response.json())
                .then(data => {
                    console.log('BVSS data loaded:', data);
                    createBVSSVisualization(data);
                })
                .catch(error => {
                    console.error('Error loading BVSS data:', error);
                    svg.append("text")
                        .attr("x", 400)
                        .attr("y", 300)
                        .attr("text-anchor", "middle")
                        .attr("fill", "#ff6b6b")
                        .text("Error loading visualization data");
                });
        }

        function createBVSSVisualization(data) {
            const classes = data.classes || [];
            const properties = data.properties || [];
            
            // Update counts
            document.getElementById('class-count').textContent = classes.length;
            document.getElementById('property-count').textContent = properties.length;
            
            // Create nodes for visualization
            const nodes = [];
            const links = [];
            
            // Add class nodes with BVSS classification
            classes.forEach((cls, index) => {
                const bfoType = classifyBFOType(cls.name);
                nodes.push({
                    id: cls.id,
                    name: cls.name,
                    type: 'class',
                    bfoType: bfoType,
                    symbol: bvssSymbols[bfoType] || bvssSymbols.default,
                    color: bvssColors[bfoType] || bvssColors.default,
                    x: 100 + (index % 8) * 80,
                    y: 100 + Math.floor(index / 8) * 60
                });
            });

            // Add property nodes
            properties.forEach((prop, index) => {
                nodes.push({
                    id: prop.id,
                    name: prop.name,
                    type: 'property',
                    bfoType: 'Relation',
                    symbol: '→',
                    color: '#03A9F4',
                    x: 100 + (index % 6) * 100,
                    y: 400 + Math.floor(index / 6) * 40
                });
            });

            // Create force simulation with better spacing
            simulation = d3.forceSimulation(nodes)
                .force("link", d3.forceLink(links).id(d => d.id).distance(120))
                .force("charge", d3.forceManyBody().strength(-500))
                .force("center", d3.forceCenter(400, 300))
                .force("collision", d3.forceCollide().radius(50));

            // Create links
            const link = g.append("g")
                .selectAll("line")
                .data(links)
                .enter().append("line")
                .attr("stroke", "#999")
                .attr("stroke-opacity", 0.6)
                .attr("stroke-width", 2);

            // Create nodes
            const node = g.append("g")
                .selectAll(".node")
                .data(nodes)
                .enter().append("g")
                .attr("class", "node")
                .call(d3.drag()
                    .on("start", dragstarted)
                    .on("drag", dragged)
                    .on("end", dragended));

            // Add background circles for better visibility
            node.append("circle")
                .attr("r", 25)
                .attr("fill", "#1a1a1a")
                .attr("stroke", d => d.color)
                .attr("stroke-width", 2);

            // Add BVSS symbols - much larger and more visible
            node.append("text")
                .attr("text-anchor", "middle")
                .attr("dominant-baseline", "central")
                .attr("font-size", "32px")
                .attr("font-weight", "bold")
                .attr("fill", d => d.color)
                .text(d => d.symbol);

            // Add labels below nodes
            node.append("text")
                .attr("text-anchor", "middle")
                .attr("dy", "45px")
                .attr("font-size", "14px")
                .attr("font-weight", "bold")
                .attr("fill", "#ffffff")
                .text(d => d.name.replace(/.*#/, ''));

            // Add BFO type labels
            node.append("text")
                .attr("text-anchor", "middle")
                .attr("dy", "60px")
                .attr("font-size", "10px")
                .attr("fill", "#aaa")
                .text(d => d.bfoType);

            // Add tooltips
            node.append("title")
                .text(d => `${d.name}\nBFO Type: ${d.bfoType}`);

            // Update positions on simulation tick
            simulation.on("tick", () => {
                link
                    .attr("x1", d => d.source.x)
                    .attr("y1", d => d.source.y)
                    .attr("x2", d => d.target.x)
                    .attr("y2", d => d.target.y);

                node
                    .attr("transform", d => `translate(${d.x},${d.y})`);
            });
        }

        function dragstarted(event, d) {
            if (!event.active) simulation.alphaTarget(0.3).restart();
            d.fx = d.x;
            d.fy = d.y;
        }

        function dragged(event, d) {
            d.fx = event.x;
            d.fy = event.y;
        }

        function dragended(event, d) {
            if (!event.active) simulation.alphaTarget(0);
            d.fx = null;
            d.fy = null;
        }

        function resetView() {
            svg.transition().duration(750).call(
                zoom.transform,
                d3.zoomIdentity
            );
        }

        function centerGraph() {
            const bounds = g.node().getBBox();
            const width = +svg.attr("width");
            const height = +svg.attr("height");
            const midX = bounds.x + bounds.width / 2;
            const midY = bounds.y + bounds.height / 2;
            const scale = 0.9 / Math.max(bounds.width / width, bounds.height / height);
            const translate = [width / 2 - scale * midX, height / 2 - scale * midY];
            
            svg.transition().duration(750).call(
                zoom.transform,
                d3.zoomIdentity.translate(translate[0], translate[1]).scale(scale)
            );
        }

        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', initializeVisualization);
    </script>
</body>
</html>