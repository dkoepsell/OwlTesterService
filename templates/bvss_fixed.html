<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BVSS Visualization - {{ file.original_filename }}</title>
    <link href="https://cdn.replit.com/agent/bootstrap-agent-dark-theme.min.css" rel="stylesheet">
    <script src="https://d3js.org/d3.v7.min.js"></script>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark">
        <div class="container">
            <a class="navbar-brand" href="/">FOL-BFO-OWL Tester</a>
            <div class="navbar-nav ms-auto">
                <a class="nav-link" href="/history">Back to History</a>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <h1 class="mb-4">BFO Visual Syntax System (BVSS)</h1>
        <p class="text-muted mb-4">{{ file.original_filename }}</p>
        
        <div class="alert alert-info">
            <p class="mb-0">The BFO Visual Syntax System (BVSS) provides a standardized, intuitive, and expressive visual language for representing the full set of Basic Formal Ontology (BFO) entities and relations across domains.</p>
        </div>
        
        <div class="row mb-4">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-body">
                        <h5>Ontology Information</h5>
                        <p><strong>Classes:</strong> <span id="class-count">0</span></p>
                        <p><strong>Properties:</strong> <span id="property-count">0</span></p>
                    </div>
                </div>
            </div>
        </div>

        <div style="background: #1a1a1a; border-radius: 8px; padding: 20px; margin: 20px 0;">
            <div class="mb-3">
                <button class="btn btn-secondary btn-sm" onclick="resetView()">Reset View</button>
                <button class="btn btn-secondary btn-sm" onclick="centerGraph()">Center Graph</button>
                <span class="ms-3 text-light">Drag nodes to rearrange • Scroll to zoom • Click and drag background to pan</span>
            </div>
            <svg id="bvss-svg" width="100%" height="600"></svg>
        </div>

        <div class="card">
            <div class="card-body">
                <h6>Complete BFO Visual Syntax (BVSS) Legend</h6>
                <div class="row">
                    <div class="col-md-4">
                        <h6 class="text-primary">Entity Types</h6>
                        <div class="d-flex align-items-center mb-1">
                            <svg width="20" height="20" class="me-2">
                                <circle cx="10" cy="10" r="8" fill="#4a90e2" stroke="#ffffff" stroke-width="2"/>
                            </svg>
                            <small><strong>●</strong> Independent continuant</small>
                        </div>
                        <div class="d-flex align-items-center mb-1">
                            <svg width="20" height="20" class="me-2">
                                <circle cx="10" cy="10" r="8" fill="none" stroke="#dc2626" stroke-width="2" stroke-dasharray="4,2"/>
                            </svg>
                            <small><strong>◌</strong> Dependent continuant</small>
                        </div>
                        <div class="d-flex align-items-center mb-1">
                            <svg width="20" height="20" class="me-2">
                                <rect x="2" y="2" width="16" height="16" fill="#6b7280" stroke="#ffffff" stroke-width="2"/>
                            </svg>
                            <small><strong>■</strong> Generically dependent</small>
                        </div>
                        <div class="d-flex align-items-center mb-1">
                            <svg width="20" height="20" class="me-2">
                                <path d="M2,10 L18,10 M14,6 L18,10 L14,14" stroke="#10b981" stroke-width="2" fill="none"/>
                            </svg>
                            <small><strong>⟶</strong> Process</small>
                        </div>
                        <div class="d-flex align-items-center mb-1">
                            <svg width="20" height="20" class="me-2">
                                <path d="M4,4 L16,4 L16,16 L4,16 Z" stroke="#ea580c" stroke-width="2" fill="none"/>
                            </svg>
                            <small><strong>⟷</strong> Temporal region</small>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <h6 class="text-success">Relations</h6>
                        <div class="d-flex align-items-center mb-1">
                            <svg width="20" height="20" class="me-2">
                                <path d="M10,16 L10,4 M6,8 L10,4 L14,8" stroke="#3b82f6" stroke-width="2" fill="none"/>
                            </svg>
                            <small><strong>↑</strong> is_a</small>
                        </div>
                        <div class="d-flex align-items-center mb-1">
                            <svg width="20" height="20" class="me-2">
                                <path d="M2,10 L18,10 M14,6 L18,10 L14,14" stroke="#9ca3af" stroke-width="2" stroke-dasharray="4,2" fill="none"/>
                            </svg>
                            <small><strong>→</strong> Connected via</small>
                        </div>
                        <div class="d-flex align-items-center mb-1">
                            <svg width="20" height="20" class="me-2">
                                <circle cx="10" cy="8" r="3" fill="none" stroke="#f59e0b" stroke-width="2"/>
                                <path d="M10,11 L10,17 M6,15 L10,17 L14,15" stroke="#f59e0b" stroke-width="2" fill="none"/>
                            </svg>
                            <small><strong>◯→</strong> Inherent in</small>
                        </div>
                        <div class="d-flex align-items-center mb-1">
                            <svg width="20" height="20" class="me-2">
                                <path d="M2,8 L18,8 M2,12 L18,12 M14,4 L18,8 L14,12" stroke="#10b981" stroke-width="2" fill="none"/>
                            </svg>
                            <small><strong>⇨</strong> Participates in</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Fetch visualization data
            fetch('/api/bvss/{{ filename }}')
                .then(response => response.json())
                .then(data => {
                    console.log('BVSS data received:', data);
                    createBVSSVisualization(data);
                })
                .catch(error => {
                    console.error('Error loading BVSS data:', error);
                    // Show error in the SVG
                    d3.select('#bvss-svg')
                        .append('text')
                        .attr('x', '50%')
                        .attr('y', '50%')
                        .attr('text-anchor', 'middle')
                        .attr('fill', 'white')
                        .text('Error loading visualization data');
                });

            function createBVSSVisualization(data) {
                const classes = data.classes || [];
                const properties = data.properties || [];
                const inheritance = data.inheritance || [];
                const nodes = data.nodes || [];
                const edges = data.edges || [];
                
                // Update counts
                document.getElementById('class-count').textContent = classes.length;
                document.getElementById('property-count').textContent = properties.length;

                const svg = d3.select('#bvss-svg');
                const width = 800;
                const height = 600;
                
                svg.attr('width', width).attr('height', height);
                
                // Clear any existing content
                svg.selectAll('*').remove();

                // Create container group
                const container = svg.append('g');

                // Set up zoom
                const zoom = d3.zoom()
                    .scaleExtent([0.1, 4])
                    .on('zoom', function(event) {
                        container.attr('transform', event.transform);
                    });

                svg.call(zoom);

                // Add pattern definitions for hatching and arrowheads
                const defs = svg.append('defs');
                defs.append('pattern')
                    .attr('id', 'hatch')
                    .attr('patternUnits', 'userSpaceOnUse')
                    .attr('width', 8)
                    .attr('height', 8)
                    .append('path')
                    .attr('d', 'M0,8 L8,0 M-2,2 L2,-2 M6,10 L10,6')
                    .attr('stroke', '#9ca3af')
                    .attr('stroke-width', 1);

                // Add authentic BVSS arrowhead markers
                const arrowheads = [
                    {id: 'arrowhead-subsumption', color: '#3b82f6', size: 8},
                    {id: 'arrowhead-part-of', color: '#9ca3af', size: 6},
                    {id: 'arrowhead-participates', color: '#f59e0b', size: 10},
                    {id: 'arrowhead-small', color: '#7c3aed', size: 4},
                    {id: 'arrowhead-thin', color: '#dc2626', size: 6},
                    {id: 'arrowhead-pinhead', color: '#10b981', size: 5},
                    {id: 'arrowhead-curved', color: '#ea580c', size: 7},
                    {id: 'arrowhead-reverse', color: '#6b7280', size: 6},
                    {id: 'arrowhead-default', color: '#666', size: 6}
                ];

                arrowheads.forEach(arrow => {
                    defs.append('marker')
                        .attr('id', arrow.id)
                        .attr('viewBox', '0 -5 10 10')
                        .attr('refX', 10)
                        .attr('refY', 0)
                        .attr('markerWidth', arrow.size)
                        .attr('markerHeight', arrow.size)
                        .attr('orient', 'auto')
                        .append('path')
                        .attr('d', 'M0,-5L10,0L0,5')
                        .attr('fill', arrow.color);
                });

                // Extract authentic nodes from your ontology with proper BFO classification
                if (nodes && nodes.length > 0) {
                    // Use the real extracted nodes from your ontology
                    nodes.forEach(node => {
                        ontologyNodes.push({
                            id: node.id,
                            name: node.name || node.label,
                            type: node.type === 'Relation' ? 'property' : 'class',
                            bfoCategory: node.type === 'Relation' ? 'relation' : classifyDetailedBFOCategory(node.name || node.label),
                            description: node.description,
                            temporal: node.temporal
                        });
                    });
                } else {
                    // Extract from classes and properties if nodes not available
                    classes.forEach(cls => {
                        ontologyNodes.push({
                            id: cls.id,
                            name: cls.name,
                            type: 'class',
                            bfoCategory: classifyDetailedBFOCategory(cls.name)
                        });
                    });
                    
                    properties.forEach(prop => {
                        ontologyNodes.push({
                            id: prop.id || prop.name,
                            name: prop.name,
                            type: 'property',
                            bfoCategory: 'relation'
                        });
                    });
                }
                
                // BFO scaffolding nodes
                const bfoNodes = [
                    // Top level
                    {id: 'Entity', name: 'Entity', type: 'bfo', bfoCategory: 'entity', x: width/2, y: 50},
                    
                    // Level 1
                    {id: 'Continuant', name: 'Continuant', type: 'bfo', bfoCategory: 'continuant', x: width/3, y: 120},
                    {id: 'Occurrent', name: 'Occurrent', type: 'bfo', bfoCategory: 'process', x: 2*width/3, y: 120},
                    
                    // Level 2 - Continuants
                    {id: 'IndependentContinuant', name: 'Independent Continuant', type: 'bfo', bfoCategory: 'independent', x: width/6, y: 190},
                    {id: 'DependentContinuant', name: 'Dependent Continuant', type: 'bfo', bfoCategory: 'dependent', x: width/2, y: 190},
                    {id: 'SpatialRegion', name: 'Spatial Region', type: 'bfo', bfoCategory: 'immaterial', x: 5*width/6, y: 190},
                    
                    // Level 3 - Independent Continuants
                    {id: 'MaterialEntity', name: 'Material Entity', type: 'bfo', bfoCategory: 'material', x: width/12, y: 260},
                    {id: 'ImmaterialEntity', name: 'Immaterial Entity', type: 'bfo', bfoCategory: 'immaterial', x: 3*width/12, y: 260},
                    
                    // Level 4 - Material Entities
                    {id: 'ObjectAggregate', name: 'Object Aggregate', type: 'bfo', bfoCategory: 'object-aggregate', x: width/20, y: 330},
                    {id: 'FiatObjectPart', name: 'Fiat Object Part', type: 'bfo', bfoCategory: 'fiat-object-part', x: 3*width/20, y: 330},
                    
                    // Level 3 - Dependent Continuants
                    {id: 'SpecificallyDependentContinuant', name: 'Specifically Dependent', type: 'bfo', bfoCategory: 'specifically-dependent', x: 7*width/12, y: 260},
                    {id: 'GenericallyDependentContinuant', name: 'Generically Dependent', type: 'bfo', bfoCategory: 'generic-dependent', x: 9*width/12, y: 260},
                    
                    // Level 4 - Specifically Dependent
                    {id: 'Quality', name: 'Quality', type: 'bfo', bfoCategory: 'quality', x: 6*width/12, y: 330},
                    {id: 'Function', name: 'Function', type: 'bfo', bfoCategory: 'function', x: 7*width/12, y: 330},
                    {id: 'Disposition', name: 'Disposition', type: 'bfo', bfoCategory: 'disposition', x: 8*width/12, y: 330},
                    
                    // Level 2 - Occurrents
                    {id: 'Process', name: 'Process', type: 'bfo', bfoCategory: 'process', x: 11*width/12, y: 190},
                    {id: 'ProcessAggregate', name: 'Process Aggregate', type: 'bfo', bfoCategory: 'process-aggregate', x: 19*width/20, y: 260},
                    {id: 'SpatiotemporalRegion', name: 'Spatiotemporal Region', type: 'bfo', bfoCategory: 'spatiotemporal-region', x: 17*width/20, y: 260},
                    {id: 'TemporalInstant', name: 'Temporal Instant', type: 'bfo', bfoCategory: 'temporal-instant', x: 18*width/20, y: 330}
                ];
                
                // Combine all nodes for visualization  
                const allNodes = [...bfoNodes, ...ontologyNodes];

                // Properties are already included in ontologyNodes above

                // Create links - Complete BFO hierarchy
                const links = [];
                
                // Complete BFO hierarchy with all relationships
                links.push(
                    // Level 1
                    {source: 'Entity', target: 'Continuant', type: 'subsumption'},
                    {source: 'Entity', target: 'Occurrent', type: 'subsumption'},
                    
                    // Level 2 - Continuants
                    {source: 'Continuant', target: 'IndependentContinuant', type: 'subsumption'},
                    {source: 'Continuant', target: 'DependentContinuant', type: 'subsumption'},
                    {source: 'Continuant', target: 'SpatialRegion', type: 'subsumption'},
                    
                    // Level 3 - Independent Continuants
                    {source: 'IndependentContinuant', target: 'MaterialEntity', type: 'subsumption'},
                    {source: 'IndependentContinuant', target: 'ImmaterialEntity', type: 'subsumption'},
                    
                    // Level 4 - Material Entities
                    {source: 'MaterialEntity', target: 'ObjectAggregate', type: 'subsumption'},
                    {source: 'MaterialEntity', target: 'FiatObjectPart', type: 'subsumption'},
                    
                    // Level 3 - Dependent Continuants
                    {source: 'DependentContinuant', target: 'SpecificallyDependentContinuant', type: 'subsumption'},
                    {source: 'DependentContinuant', target: 'GenericallyDependentContinuant', type: 'subsumption'},
                    
                    // Level 4 - Specifically Dependent
                    {source: 'SpecificallyDependentContinuant', target: 'Quality', type: 'subsumption'},
                    {source: 'SpecificallyDependentContinuant', target: 'Function', type: 'subsumption'},
                    {source: 'SpecificallyDependentContinuant', target: 'Disposition', type: 'subsumption'},
                    
                    // Level 2 - Occurrents
                    {source: 'Occurrent', target: 'Process', type: 'subsumption'},
                    {source: 'Occurrent', target: 'SpatiotemporalRegion', type: 'subsumption'},
                    
                    // Level 3 - Processes
                    {source: 'Process', target: 'ProcessAggregate', type: 'subsumption'},
                    {source: 'SpatiotemporalRegion', target: 'TemporalInstant', type: 'subsumption'}
                );
                
                // Use authentic relationships from the ontology
                if (edges && edges.length > 0) {
                    edges.forEach(edge => {
                        let linkType = 'subsumption'; // default
                        
                        // Map authentic relationship types to BVSS relations
                        switch(edge.relation) {
                            case 'is_a':
                            case 'inheritance':
                                linkType = 'subsumption';
                                break;
                            case 'part_of':
                                linkType = 'part_of';
                                break;
                            case 'participates_in':
                                linkType = 'participates_in';
                                break;
                            case 'has_role':
                            case 'has_quality':
                                linkType = 'has_role';
                                break;
                            case 'inheres_in':
                                linkType = 'inheres_in';
                                break;
                            case 'located_in':
                                linkType = 'located_in';
                                break;
                            case 'realizes':
                            case 'is_realized_by':
                                linkType = 'realizes';
                                break;
                            case 'has_participant':
                                linkType = 'has_participant';
                                break;
                            case 'has_property':
                            case 'domain':
                            case 'range':
                            case 'points_to':
                                linkType = 'property_relation';
                                break;
                            default:
                                linkType = 'subsumption';
                        }
                        
                        links.push({
                            source: edge.source,
                            target: edge.target,
                            type: linkType,
                            relation: edge.relation,
                            label: edge.relation
                        });
                    });
                } else {
                    // Fallback: extract from properties if no edges provided
                    if (properties && properties.length > 0) {
                        properties.forEach(prop => {
                            if (prop.domain && prop.range) {
                                links.push({
                                    source: prop.domain,
                                    target: prop.range,
                                    type: 'property_relation',
                                    label: prop.name
                                });
                            }
                        });
                    }
                    
                    // Extract subclass relationships
                    classes.forEach(cls => {
                        if (cls.parent && cls.parent !== cls.id) {
                            links.push({
                                source: cls.parent,
                                target: cls.id,
                                type: 'subsumption'
                            });
                        }
                    });
                }

                // Create force simulation
                const simulation = d3.forceSimulation(allNodes)
                    .force('link', d3.forceLink(links).id(d => d.id).distance(100))
                    .force('charge', d3.forceManyBody().strength(-300))
                    .force('center', d3.forceCenter(width / 2, height / 2))
                    .force('collision', d3.forceCollide().radius(30));

                // Create links with authentic BVSS relation styles
                const link = container.selectAll('.link')
                    .data(links)
                    .enter()
                    .append('line')
                    .attr('class', 'link')
                    .attr('stroke', d => {
                        switch(d.type) {
                            case 'subsumption': return '#3b82f6';  // is_a ↑ solid line
                            case 'part_of': return '#9ca3af';      // part_of → dashed line
                            case 'participates_in': return '#f59e0b';  // participates_in ⇨ double line
                            case 'has_role': return '#7c3aed';     // has_role/has_quality → small arrow
                            case 'inheres_in': return '#dc2626';   // inheres_in ⇒ thin arrow
                            case 'located_in': return '#10b981';   // located_in → (pinhead)
                            case 'realizes': return '#ea580c';     // realizes ↻ curved arrow
                            case 'has_participant': return '#6b7280';  // has_participant ⇐ reverse arrow
                            case 'property_relation': return '#f97316';
                            case 'instantiation': return '#10b981';
                            default: return '#666';
                        }
                    })
                    .attr('stroke-width', d => {
                        switch(d.type) {
                            case 'subsumption': return 3;          // Solid line for is_a
                            case 'participates_in': return 4;      // Double line effect
                            case 'inheres_in': return 1;           // Thin arrow
                            case 'part_of': return 2;              // Dashed line
                            default: return 2;
                        }
                    })
                    .attr('stroke-dasharray', d => {
                        switch(d.type) {
                            case 'part_of': return '8,4';          // Dashed for part_of
                            case 'has_role': return '3,2';         // Small dash for has_role
                            default: return null;
                        }
                    })
                    .attr('marker-end', d => {
                        switch(d.type) {
                            case 'subsumption': return 'url(#arrowhead-subsumption)';
                            case 'part_of': return 'url(#arrowhead-part-of)';
                            case 'participates_in': return 'url(#arrowhead-participates)';
                            case 'has_role': return 'url(#arrowhead-small)';
                            case 'inheres_in': return 'url(#arrowhead-thin)';
                            case 'located_in': return 'url(#arrowhead-pinhead)';
                            case 'realizes': return 'url(#arrowhead-curved)';
                            case 'has_participant': return 'url(#arrowhead-reverse)';
                            default: return 'url(#arrowhead-default)';
                        }
                    });

                // Create node groups
                const node = container.selectAll('.node')
                    .data(allNodes)
                    .enter()
                    .append('g')
                    .attr('class', 'node')
                    .call(d3.drag()
                        .on('start', dragstarted)
                        .on('drag', dragged)
                        .on('end', dragended));

                // Add BVSS symbols based on BFO category
                node.each(function(d) {
                    const g = d3.select(this);
                    
                    switch(d.bfoCategory) {
                        case 'independent':
                        case 'entity':
                        case 'continuant':
                            // Independent Continuant: Solid circle ●
                            g.append('circle')
                                .attr('r', 20)
                                .attr('fill', '#4a90e2')
                                .attr('stroke', '#fff')
                                .attr('stroke-width', 2);
                            break;
                            
                        case 'material':
                            // Material Entity: Filled gray square ■
                            g.append('rect')
                                .attr('x', -15)
                                .attr('y', -15)
                                .attr('width', 30)
                                .attr('height', 30)
                                .attr('fill', '#6b7280')
                                .attr('stroke', '#fff')
                                .attr('stroke-width', 2);
                            break;
                            
                        case 'immaterial':
                            // Immaterial Entity: Hollow square □
                            g.append('rect')
                                .attr('x', -15)
                                .attr('y', -15)
                                .attr('width', 30)
                                .attr('height', 30)
                                .attr('fill', 'none')
                                .attr('stroke', '#9ca3af')
                                .attr('stroke-width', 2);
                            break;
                            
                        case 'object-aggregate':
                            // Object Aggregate: Thick square ⬛
                            g.append('rect')
                                .attr('x', -18)
                                .attr('y', -18)
                                .attr('width', 36)
                                .attr('height', 36)
                                .attr('fill', '#374151')
                                .attr('stroke', '#fff')
                                .attr('stroke-width', 3);
                            break;
                            
                        case 'fiat-object-part':
                            // Fiat Object Part: Hatched rectangle ▭
                            g.append('rect')
                                .attr('x', -20)
                                .attr('y', -12)
                                .attr('width', 40)
                                .attr('height', 24)
                                .attr('fill', 'url(#hatch)')
                                .attr('stroke', '#fff')
                                .attr('stroke-width', 2);
                            break;
                            
                        case 'dependent':
                            // Dependent Continuant: Dashed circle ◌
                            g.append('circle')
                                .attr('r', 20)
                                .attr('fill', 'none')
                                .attr('stroke', '#dc2626')
                                .attr('stroke-width', 2)
                                .attr('stroke-dasharray', '5,5');
                            break;
                            
                        case 'specifically-dependent':
                            // Specifically Dependent: Dashed circle with anchor ◌+anchor
                            g.append('circle')
                                .attr('r', 20)
                                .attr('fill', 'none')
                                .attr('stroke', '#dc2626')
                                .attr('stroke-width', 2)
                                .attr('stroke-dasharray', '5,5');
                            g.append('path')
                                .attr('d', 'M0,20 L0,35 M-5,30 L0,35 L5,30')
                                .attr('stroke', '#dc2626')
                                .attr('stroke-width', 2)
                                .attr('fill', 'none');
                            break;
                            
                        case 'generic-dependent':
                            // Generically Dependent: Dashed circle with migration symbol ◌+↺
                            g.append('circle')
                                .attr('r', 20)
                                .attr('fill', 'none')
                                .attr('stroke', '#dc2626')
                                .attr('stroke-width', 2)
                                .attr('stroke-dasharray', '5,5');
                            g.append('path')
                                .attr('d', 'M25,0 A15,15 0 1,1 25,-15')
                                .attr('stroke', '#dc2626')
                                .attr('stroke-width', 2)
                                .attr('fill', 'none');
                            g.append('path')
                                .attr('d', 'M35,-5 L40,0 L35,5')
                                .attr('stroke', '#dc2626')
                                .attr('stroke-width', 2)
                                .attr('fill', 'none');
                            break;
                            
                        case 'quality':
                            // Quality: Tiny dot ◦
                            g.append('circle')
                                .attr('r', 8)
                                .attr('fill', '#7c3aed')
                                .attr('stroke', '#fff')
                                .attr('stroke-width', 1);
                            break;
                            
                        case 'function':
                        case 'disposition':
                            // Function/Disposition: Hammer icon ⚒
                            g.append('path')
                                .attr('d', 'M-10,-15 L10,-5 M-5,-10 L5,0 M0,-15 L0,15 M-15,10 L15,10')
                                .attr('stroke', '#ea580c')
                                .attr('stroke-width', 2)
                                .attr('fill', 'none');
                            break;
                            
                        case 'process':
                            // Process: Directed arrow ⟶
                            g.append('path')
                                .attr('d', 'M-20,0 L20,0 M15,-5 L20,0 L15,5')
                                .attr('stroke', '#10b981')
                                .attr('stroke-width', 3)
                                .attr('fill', 'none');
                            break;
                            
                        case 'process-aggregate':
                            // Process Aggregate: Double arrows ⟶⟶
                            g.append('path')
                                .attr('d', 'M-20,-5 L20,-5 M15,-10 L20,-5 L15,0')
                                .attr('stroke', '#10b981')
                                .attr('stroke-width', 3)
                                .attr('fill', 'none');
                            g.append('path')
                                .attr('d', 'M-20,5 L20,5 M15,0 L20,5 L15,10')
                                .attr('stroke', '#10b981')
                                .attr('stroke-width', 3)
                                .attr('fill', 'none');
                            break;
                            
                        case 'spatiotemporal-region':
                            // Spatiotemporal Region: Ring overlay ◬
                            g.append('circle')
                                .attr('r', 20)
                                .attr('fill', 'none')
                                .attr('stroke', '#f59e0b')
                                .attr('stroke-width', 3);
                            g.append('circle')
                                .attr('r', 12)
                                .attr('fill', 'none')
                                .attr('stroke', '#f59e0b')
                                .attr('stroke-width', 2);
                            break;
                            
                        case 'temporal-instant':
                            // Temporal Instant: Timeline marker |
                            g.append('line')
                                .attr('x1', 0)
                                .attr('y1', -20)
                                .attr('x2', 0)
                                .attr('y2', 20)
                                .attr('stroke', '#f59e0b')
                                .attr('stroke-width', 4);
                            break;
                            
                        case 'relation':
                            // Relations: Diamond
                            g.append('path')
                                .attr('d', 'M0,-15 L15,0 L0,15 L-15,0 Z')
                                .attr('fill', '#f59e0b')
                                .attr('stroke', '#fff')
                                .attr('stroke-width', 2);
                            break;
                            
                        default:
                            // Default circle
                            g.append('circle')
                                .attr('r', 15)
                                .attr('fill', '#6b7280')
                                .attr('stroke', '#fff')
                                .attr('stroke-width', 2);
                    }
                });

                // Add labels
                node.append('text')
                    .attr('dy', 35)
                    .attr('text-anchor', 'middle')
                    .attr('fill', '#fff')
                    .attr('font-size', '12px')
                    .text(d => d.name);

                // Update positions on tick
                simulation.on('tick', () => {
                    link
                        .attr('x1', d => d.source.x)
                        .attr('y1', d => d.source.y)
                        .attr('x2', d => d.target.x)
                        .attr('y2', d => d.target.y);

                    node
                        .attr('transform', d => `translate(${d.x},${d.y})`);
                });

                // Drag functions
                function dragstarted(event, d) {
                    if (!event.active) simulation.alphaTarget(0.3).restart();
                    d.fx = d.x;
                    d.fy = d.y;
                }

                function dragged(event, d) {
                    d.fx = event.x;
                    d.fy = event.y;
                }

                function dragended(event, d) {
                    if (!event.active) simulation.alphaTarget(0);
                    d.fx = null;
                    d.fy = null;
                }

                // Global functions for controls
                window.resetView = function() {
                    svg.transition().duration(750).call(
                        zoom.transform,
                        d3.zoomIdentity
                    );
                };

                window.centerGraph = function() {
                    const bounds = container.node().getBBox();
                    const fullWidth = width;
                    const fullHeight = height;
                    const width_calc = bounds.width;
                    const height_calc = bounds.height;
                    const midX = bounds.x + width_calc / 2;
                    const midY = bounds.y + height_calc / 2;
                    
                    const scale = Math.min(fullWidth / width_calc, fullHeight / height_calc) * 0.8;
                    const translate = [fullWidth / 2 - scale * midX, fullHeight / 2 - scale * midY];
                    
                    svg.transition().duration(750).call(
                        zoom.transform,
                        d3.zoomIdentity.translate(translate[0], translate[1]).scale(scale)
                    );
                };
            }

            function classifyDetailedBFOCategory(className) {
                const name = className.toLowerCase();
                
                // Complete BFO classification for all 14 entity types
                // Material entities
                if (name.includes('cell') || name.includes('rock') || name.includes('molecule') || name.includes('evidence') || name.includes('fact')) {
                    return 'material';
                }
                
                // Object aggregates
                if (name.includes('team') || name.includes('flock') || name.includes('group') || name.includes('institution')) {
                    return 'object-aggregate';
                }
                
                // Fiat object parts
                if (name.includes('hemisphere') || name.includes('part') || name.includes('component')) {
                    return 'fiat-object-part';
                }
                
                // Immaterial entities / Spatial regions
                if (name.includes('region') || name.includes('jurisdiction') || name.includes('space')) {
                    return 'immaterial';
                }
                
                // Specifically dependent continuants
                if (name.includes('role') || name.includes('right') || name.includes('obligation')) {
                    return 'specifically-dependent';
                }
                
                // Generically dependent continuants
                if (name.includes('document') || name.includes('contract') || name.includes('statute') || name.includes('regulation') || name.includes('text') || name.includes('license')) {
                    return 'generic-dependent';
                }
                
                // Qualities
                if (name.includes('color') || name.includes('redness') || name.includes('quality') || name.includes('normativity')) {
                    return 'quality';
                }
                
                // Functions and dispositions
                if (name.includes('authority') || name.includes('function') || name.includes('disposition') || name.includes('fragility') || name.includes('digestion')) {
                    return 'function';
                }
                
                // Process aggregates
                if (name.includes('symphony') || name.includes('performance') || name.includes('phase')) {
                    return 'process-aggregate';
                }
                
                // Processes
                if (name.includes('trial') || name.includes('process') || name.includes('adjudication') || name.includes('proceeding') || name.includes('enforcement')) {
                    return 'process';
                }
                
                // Spatiotemporal regions
                if (name.includes('interval') || name.includes('period') || name.includes('temporally')) {
                    return 'spatiotemporal-region';
                }
                
                // Temporal instants
                if (name.includes('instant') || name.includes('moment') || name.includes('time')) {
                    return 'temporal-instant';
                }
                
                // Independent continuants (agents, persons, courts)
                if (name.includes('agent') || name.includes('person') || name.includes('court') || name.includes('entity')) {
                    return 'independent';
                }
                
                return 'independent'; // Default for legal entities
            }

            function getBFOParent(className) {
                const name = className.toLowerCase();
                
                // Map legal concepts to appropriate BFO parents
                if (name.includes('agent') || name.includes('person') || name.includes('court')) {
                    return 'IndependentContinuant';
                }
                if (name.includes('entity') || name.includes('fact') || name.includes('evidence')) {
                    return 'MaterialEntity';
                }
                if (name.includes('role') || name.includes('right') || name.includes('obligation')) {
                    return 'SpecificallyDependentContinuant';
                }
                if (name.includes('authority') || name.includes('jurisdiction')) {
                    return 'Function';
                }
                if (name.includes('document') || name.includes('contract') || name.includes('statute') || name.includes('regulation')) {
                    return 'GenericallyDependentContinuant';
                }
                if (name.includes('trial') || name.includes('process') || name.includes('adjudication') || name.includes('proceeding')) {
                    return 'Process';
                }
                
                return 'IndependentContinuant'; // Default
            }
        });
    </script>
</body>
</html>