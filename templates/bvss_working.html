<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BVSS Visualization - {{ file.original_filename }}</title>
    <link href="https://cdn.replit.com/agent/bootstrap-agent-dark-theme.min.css" rel="stylesheet">
    <script src="https://d3js.org/d3.v7.min.js"></script>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark">
        <div class="container">
            <a class="navbar-brand" href="{{ url_for('index') }}">FOL-BFO-OWL Tester</a>
            <div class="navbar-nav ms-auto">
                <a class="nav-link" href="{{ url_for('view_history') }}">Back to History</a>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <h1 class="mb-4">BVSS Visualization: {{ file.original_filename }}</h1>
        
        <div class="alert alert-info">
            <h6 class="mb-2">BFO Visual Syntax System (BVSS)</h6>
            <p class="mb-0">The BFO Visual Syntax System (BVSS) provides a standardized, intuitive, and expressive visual language for representing the full set of Basic Formal Ontology (BFO) entities and relations across domains. It enables the creation of legible, interoperable diagrams that support teaching, modeling, and ontology validation.</p>
        </div>
        
        <div class="card mb-4">
            <div class="card-body">
                <h5>Ontology Information</h5>
                <p><strong>Classes:</strong> 26</p>
                <p><strong>Properties:</strong> 11</p>
            </div>
        </div>

        <div style="background: #1a1a1a; border-radius: 8px; padding: 20px; margin: 20px 0;">
            <div class="mb-3">
                <button class="btn btn-secondary btn-sm" id="reset-zoom">Reset View</button>
                <button class="btn btn-secondary btn-sm" id="center-graph">Center Graph</button>
                <span class="ms-3 text-light">Drag nodes to rearrange ‚Ä¢ Scroll to zoom ‚Ä¢ Click and drag background to pan</span>
            </div>
            <div id="viz-container"></div>
        </div>

        <div class="card">
            <div class="card-body">
                <h6>Complete BFO Visual Syntax (BVSS) Legend</h6>
                <div class="row">
                    <div class="col-md-4">
                        <h6 class="text-primary">Entity Types</h6>
                        <div class="d-flex align-items-center mb-1">
                            <svg width="20" height="20" class="me-2">
                                <circle cx="10" cy="10" r="8" fill="none" stroke="#000000" stroke-width="2"/>
                            </svg>
                            <small><strong>‚óè</strong> Independent continuant</small>
                        </div>
                        <div class="d-flex align-items-center mb-1">
                            <svg width="20" height="20" class="me-2">
                                <circle cx="10" cy="10" r="6" fill="none" stroke="#000000" stroke-width="2" stroke-dasharray="2,2"/>
                            </svg>
                            <small><strong>‚óå</strong> Dependent continuant</small>
                        </div>
                        <div class="d-flex align-items-center mb-1">
                            <svg width="20" height="20" class="me-2">
                                <rect x="4" y="2" width="12" height="16" fill="none" stroke="#000000" stroke-width="2"/>
                                <line x1="6" y1="6" x2="14" y2="6" stroke="#000000" stroke-width="1"/>
                                <line x1="6" y1="10" x2="14" y2="10" stroke="#000000" stroke-width="1"/>
                                <line x1="6" y1="14" x2="14" y2="14" stroke="#000000" stroke-width="1"/>
                            </svg>
                            <small><strong>üìÑ</strong> Generically dependent</small>
                        </div>
                        <div class="d-flex align-items-center mb-1">
                            <svg width="20" height="20" class="me-2">
                                <polygon points="2,10 15,6 15,8 18,10 15,12 15,14" fill="#000000"/>
                            </svg>
                            <small><strong>‚ü∂</strong> Process</small>
                        </div>
                        <div class="d-flex align-items-center mb-1">
                            <svg width="20" height="20" class="me-2">
                                <line x1="2" y1="10" x2="18" y2="10" stroke="#000000" stroke-width="2"/>
                                <polygon points="2,10 6,8 6,12" fill="#000000"/>
                                <polygon points="18,10 14,8 14,12" fill="#000000"/>
                            </svg>
                            <small><strong>‚ü∑</strong> Temporal region</small>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <h6 class="text-success">Relations</h6>
                        <div class="d-flex align-items-center mb-1">
                            <svg width="20" height="20" class="me-2">
                                <line x1="2" y1="10" x2="18" y2="10" stroke="#000000" stroke-width="3"/>
                            </svg>
                            <small><strong>‚Üë</strong> is_a</small>
                        </div>
                        <div class="d-flex align-items-center mb-1">
                            <svg width="20" height="20" class="me-2">
                                <line x1="2" y1="10" x2="18" y2="10" stroke="#000000" stroke-width="3"/>
                                <circle cx="8" cy="10" r="2" fill="#000000"/>
                            </svg>
                            <small><strong>‚Äî‚óè</strong> Connected via</small>
                        </div>
                        <div class="d-flex align-items-center mb-1">
                            <svg width="20" height="20" class="me-2">
                                <circle cx="4" cy="10" r="2" fill="none" stroke="#000000" stroke-width="1"/>
                                <line x1="6" y1="10" x2="18" y2="10" stroke="#000000" stroke-width="2"/>
                            </svg>
                            <small><strong>‚óã‚Üí</strong> Inherent in</small>
                        </div>
                        <div class="d-flex align-items-center mb-1">
                            <svg width="20" height="20" class="me-2">
                                <line x1="2" y1="10" x2="18" y2="10" stroke="#000000" stroke-width="2" stroke-dasharray="4,2"/>
                            </svg>
                            <small><strong>---‚Üí</strong> Realized by</small>
                        </div>
                        <div class="d-flex align-items-center mb-1">
                            <svg width="20" height="20" class="me-2">
                                <line x1="2" y1="8" x2="18" y2="8" stroke="#000000" stroke-width="2"/>
                                <line x1="2" y1="12" x2="18" y2="12" stroke="#000000" stroke-width="2"/>
                            </svg>
                            <small><strong>‚á®</strong> Participates in</small>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <h6 class="text-warning">Logic Operators</h6>
                        <div class="d-flex align-items-center mb-1">
                            <svg width="20" height="20" class="me-2">
                                <text x="10" y="14" text-anchor="middle" font-size="14" fill="#000000">√ó</text>
                            </svg>
                            <small><strong>√ó</strong> implies</small>
                        </div>
                        <div class="d-flex align-items-center mb-1">
                            <svg width="20" height="20" class="me-2">
                                <text x="10" y="14" text-anchor="middle" font-size="12" fill="#000000">‚áê</text>
                            </svg>
                            <small><strong>‚áê</strong> iff</small>
                        </div>
                        <div class="d-flex align-items-center mb-1">
                            <svg width="20" height="20" class="me-2">
                                <text x="10" y="14" text-anchor="middle" font-size="14" fill="#000000">√ó</text>
                            </svg>
                            <small><strong>√ó</strong> negation</small>
                        </div>
                        <div class="d-flex align-items-center mb-1">
                            <svg width="20" height="20" class="me-2">
                                <text x="10" y="14" text-anchor="middle" font-size="10" fill="#000000">I S ‚â† ‚ü∂ S √ó</text>
                            </svg>
                            <small>Formula notation</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Create the visualization
        const container = document.getElementById('viz-container');
        const width = 800;
        const height = 600;
        
        // BFO root classes following official BVSS specification
        const bfoNodes = [
            {id: "Entity", name: "Entity", shape: "circle", group: 0, bfo: true, bfoType: "entity"},
            {id: "Continuant", name: "Continuant", shape: "circle", group: 0, bfo: true, bfoType: "continuant"},
            {id: "Occurrent", name: "Occurrent", shape: "arrow", group: 0, bfo: true, bfoType: "process"},
            {id: "IndependentContinuant", name: "Independent Continuant", shape: "circle", group: 1, bfo: true, bfoType: "independent"},
            {id: "MaterialEntity", name: "Material Entity", shape: "square", group: 1, bfo: true, bfoType: "material"},
            {id: "DependentContinuant", name: "Dependent Continuant", shape: "small-dashed-circle", group: 2, bfo: true, bfoType: "dependent"},
            {id: "SpatialRegion", name: "Spatial Region", shape: "hollow-square", group: 5, bfo: true, bfoType: "spatial"},
            {id: "Process", name: "Process", shape: "arrow", group: 4, bfo: true, bfoType: "process"},
            {id: "GenericallyDependentContinuant", name: "Generically Dependent Continuant", shape: "small-dashed-circle-migrate", group: 3, bfo: true, bfoType: "generic-dependent"}
        ];

        // Your legal ontology data with complete BVSS classification
        const legalNodes = [
            {id: "Contract", name: "Contract", shape: "generically-dependent", group: 3, parent: "GenericallyDependentContinuant", bfoType: "generic-dependent"},
            {id: "Legal_Role", name: "Legal_Role", shape: "small-dashed-circle", group: 2, parent: "DependentContinuant", bfoType: "dependent"},
            {id: "Claim", name: "Claim", shape: "small-dashed-circle", group: 2, parent: "DependentContinuant", bfoType: "dependent"},
            {id: "Legal_Entity", name: "Legal_Entity", shape: "circle", group: 1, parent: "IndependentContinuant", bfoType: "independent"},
            {id: "Obligation", name: "Obligation", shape: "small-dashed-circle", group: 2, parent: "DependentContinuant", bfoType: "dependent"},
            {id: "Legal_System", name: "Legal_System", shape: "circle", group: 1, parent: "IndependentContinuant", bfoType: "independent"},
            {id: "Precedent", name: "Precedent", shape: "generically-dependent", group: 3, parent: "GenericallyDependentContinuant", bfoType: "generic-dependent"},
            {id: "Authority", name: "Authority", shape: "small-dashed-circle", group: 2, parent: "DependentContinuant", bfoType: "dependent"},
            {id: "Evidence", name: "Evidence", shape: "circle", group: 1, parent: "IndependentContinuant", bfoType: "independent"},
            {id: "Legal_Fact", name: "Legal_Fact", shape: "circle", group: 1, parent: "IndependentContinuant", bfoType: "independent"},
            {id: "Jurisdiction", name: "Jurisdiction", shape: "hollow-square", group: 5, parent: "SpatialRegion", bfoType: "spatial"},
            {id: "Right", name: "Right", shape: "small-dashed-circle", group: 2, parent: "DependentContinuant", bfoType: "dependent"},
            {id: "Legal_Person", name: "Legal_Person", shape: "circle", group: 1, parent: "IndependentContinuant", bfoType: "independent"},
            {id: "Legal_Process", name: "Legal_Process", shape: "arrow", group: 4, parent: "Process", bfoType: "process"},
            {id: "Regulation", name: "Regulation", shape: "generically-dependent", group: 3, parent: "GenericallyDependentContinuant", bfoType: "generic-dependent"},
            {id: "Judgment", name: "Judgment", shape: "generically-dependent", group: 3, parent: "GenericallyDependentContinuant", bfoType: "generic-dependent"},
            {id: "Court", name: "Court", shape: "circle", group: 1, parent: "IndependentContinuant", bfoType: "independent"},
            {id: "Statute", name: "Statute", shape: "generically-dependent", group: 3, parent: "GenericallyDependentContinuant", bfoType: "generic-dependent"},
            {id: "Legal_Document", name: "Legal_Document", shape: "generically-dependent", group: 3, parent: "GenericallyDependentContinuant", bfoType: "generic-dependent"},
            {id: "Liability", name: "Liability", shape: "small-dashed-circle", group: 2, parent: "DependentContinuant", bfoType: "dependent"},
            {id: "Legal_Interpretation", name: "Legal_Interpretation", shape: "arrow", group: 4, parent: "Process", bfoType: "process"},
            {id: "Legal_Proceeding", name: "Legal_Proceeding", shape: "arrow", group: 4, parent: "Process", bfoType: "process"},
            {id: "Legal_Capacity", name: "Legal_Capacity", shape: "small-dashed-circle", group: 2, parent: "DependentContinuant", bfoType: "dependent"},
            {id: "Legal_Status", name: "Legal_Status", shape: "small-dashed-circle", group: 2, parent: "DependentContinuant", bfoType: "dependent"},
            {id: "Legal_Relationship", name: "Legal_Relationship", shape: "small-dashed-circle", group: 2, parent: "DependentContinuant", bfoType: "dependent"},
            {id: "Legal_Event", name: "Legal_Event", shape: "arrow", group: 4, parent: "Process", bfoType: "process"},
            {id: "TrialPeriod", name: "Trial Period", shape: "temporal-region", group: 6, parent: "TemporalRegion", bfoType: "temporal"}
        ];

        const nodes = [...bfoNodes, ...legalNodes];

        // BFO hierarchy links
        const bfoLinks = [
            {source: "Entity", target: "Continuant", label: "subsumes"},
            {source: "Entity", target: "Occurrent", label: "subsumes"},
            {source: "Continuant", target: "IndependentContinuant", label: "subsumes"},
            {source: "Continuant", target: "DependentContinuant", label: "subsumes"},
            {source: "Continuant", target: "SpatialRegion", label: "subsumes"},
            {source: "DependentContinuant", target: "GenericallyDependentContinuant", label: "subsumes"},
            {source: "Occurrent", target: "Process", label: "subsumes"}
        ];

        // Legal ontology to BFO inheritance links
        const inheritanceLinks = legalNodes
            .filter(node => node.parent)
            .map(node => ({
                source: node.parent,
                target: node.id,
                label: "subsumes",
                type: "inheritance"
            }));

        // Domain-specific relationships using complete BVSS relation symbols
        const domainLinks = [
            {source: "Legal_Entity", target: "Legal_Person", label: "is_a", type: "is_a"},
            {source: "Legal_Document", target: "Contract", label: "is_a", type: "is_a"},
            {source: "Legal_Document", target: "Statute", label: "is_a", type: "is_a"},
            {source: "Legal_Process", target: "Legal_Proceeding", label: "is_a", type: "is_a"},
            {source: "Legal_Process", target: "Legal_Interpretation", label: "is_a", type: "is_a"},
            {source: "Legal_Fact", target: "Evidence", label: "is_a", type: "is_a"},
            {source: "Court", target: "Judgment", label: "determines", type: "connected_via"},
            {source: "Legal_Person", target: "Legal_Role", label: "has_role", type: "inherent_in"},
            {source: "Contract", target: "Obligation", label: "creates", type: "realized_by"},
            {source: "Legal_Process", target: "Legal_Event", label: "realizes", type: "participates_in"},
            {source: "Authority", target: "Regulation", label: "establishes", type: "realized_by"},
            {source: "Legal_Proceeding", target: "TrialPeriod", label: "occurs_during", type: "connected_via"}
        ];

        const links = [...bfoLinks, ...inheritanceLinks, ...domainLinks];

        // Create SVG with zoom and pan
        const svg = d3.create("svg")
            .attr("width", width)
            .attr("height", height)
            .style("background", "#2d3748")
            .style("border-radius", "4px");

        // Add zoom behavior
        const zoom = d3.zoom()
            .scaleExtent([0.1, 4])
            .on("zoom", (event) => {
                g.attr("transform", event.transform);
            });

        svg.call(zoom);

        // Main group for all elements
        const g = svg.append("g");

        // Define markers for arrows
        const defs = svg.append("defs");
        defs.append("marker")
            .attr("id", "arrowhead")
            .attr("viewBox", "0 -5 10 10")
            .attr("refX", 15)
            .attr("refY", 0)
            .attr("markerWidth", 6)
            .attr("markerHeight", 6)
            .attr("orient", "auto")
            .append("path")
            .attr("d", "M0,-5L10,0L0,5")
            .attr("fill", "#9ca3af");

        // Color scale - BFO classes get distinct styling
        const color = d3.scaleOrdinal()
            .domain([0, 1, 2, 3, 4, 5, 6])
            .range(["#f59e0b", "#2563eb", "#dc2626", "#059669", "#7c3aed", "#ea580c", "#6b7280"]);

        // Create force simulation
        const simulation = d3.forceSimulation(nodes)
            .force("link", d3.forceLink(links).id(d => d.id).distance(100))
            .force("charge", d3.forceManyBody().strength(-300))
            .force("center", d3.forceCenter(width / 2, height / 2))
            .force("collision", d3.forceCollide().radius(40));

        // Add links with complete BVSS relation styling
        const link = g.append("g")
            .selectAll("line")
            .data(links)
            .join("line")
            .attr("stroke", d => {
                switch(d.type) {
                    case "is_a": return "#000000"; // ‚Üë solid line
                    case "connected_via": return "#000000"; // ‚Äî‚óè Connected via
                    case "inherent_in": return "#666666"; // ‚óã‚Üí Inherent in
                    case "realized_by": return "#333333"; // ---‚Üí Realized by
                    case "participates_in": return "#000000"; // ‚á® Participates in
                    default: return "#9ca3af";
                }
            })
            .attr("stroke-width", d => {
                switch(d.type) {
                    case "is_a": return 4; // Thicker for taxonomic
                    case "participates_in": return 5; // Double line style
                    case "connected_via": return 3; // Medium for connected via
                    default: return 2;
                }
            })
            .attr("stroke-dasharray", d => {
                switch(d.type) {
                    case "inherent_in": return "2,2"; // Small dashes for inherent
                    case "realized_by": return "6,3"; // Longer dashes for realized by
                    default: return "none";
                }
            })
            .attr("marker-end", "url(#arrowhead)");

        // Add nodes group with proper drag handling
        const nodeGroup = g.append("g")
            .selectAll("g")
            .data(nodes)
            .join("g")
            .style("cursor", "pointer");

        // Draw shapes based on official BVSS specification
        nodeGroup.each(function(d) {
            const group = d3.select(this);
            const nodeColor = d.bfo ? "#000000" : color(d.group); // BFO uses black outlines
            const strokeWidth = d.bfo ? 3 : 2;
            const fillColor = d.bfo && d.bfoType === "material" ? "#808080" : "none"; // Material entities get gray fill
            
            switch(d.shape) {
                case "circle": // ‚óè Independent Continuant
                    group.append("circle")
                        .attr("r", 20)
                        .attr("fill", fillColor)
                        .attr("stroke", nodeColor)
                        .attr("stroke-width", strokeWidth);
                    break;
                case "square": // ‚ñ† Material Entity
                    group.append("rect")
                        .attr("x", -20)
                        .attr("y", -20)
                        .attr("width", 40)
                        .attr("height", 40)
                        .attr("fill", d.bfo ? "#808080" : "#d1d5db")
                        .attr("stroke", nodeColor)
                        .attr("stroke-width", strokeWidth);
                    break;
                case "hollow-square": // ‚ñ° Spatial Region (Immaterial Entity)
                    group.append("rect")
                        .attr("x", -20)
                        .attr("y", -20)
                        .attr("width", 40)
                        .attr("height", 40)
                        .attr("fill", "none")
                        .attr("stroke", nodeColor)
                        .attr("stroke-width", strokeWidth)
                        .attr("stroke-dasharray", "4,4");
                    break;
                case "small-dashed-circle": // ‚óå Dependent Continuant
                    group.append("circle")
                        .attr("r", 15)
                        .attr("fill", "none")
                        .attr("stroke", nodeColor)
                        .attr("stroke-width", strokeWidth)
                        .attr("stroke-dasharray", "3,3");
                    break;
                case "small-dashed-circle-migrate": // ‚óå + ‚Ü∫ Generically Dependent
                    group.append("circle")
                        .attr("r", 15)
                        .attr("fill", "none")
                        .attr("stroke", nodeColor)
                        .attr("stroke-width", strokeWidth)
                        .attr("stroke-dasharray", "3,3");
                    group.append("text")
                        .attr("x", 18)
                        .attr("y", -15)
                        .attr("font-size", "12px")
                        .attr("fill", nodeColor)
                        .text("‚Ü∫");
                    break;
                case "arrow": // ‚ü∂ Process (Occurrent)
                    group.append("polygon")
                        .attr("points", "-20,0 15,-8 15,-3 25,0 15,3 15,8")
                        .attr("fill", nodeColor)
                        .attr("stroke", nodeColor)
                        .attr("stroke-width", 1);
                    break;
                case "generically-dependent": // üìÑ Generically Dependent Continuant
                    group.append("rect")
                        .attr("x", -18)
                        .attr("y", -22)
                        .attr("width", 36)
                        .attr("height", 44)
                        .attr("rx", 2)
                        .attr("fill", "none")
                        .attr("stroke", nodeColor)
                        .attr("stroke-width", strokeWidth);
                    // Add lines to simulate document
                    for(let i = 0; i < 3; i++) {
                        group.append("line")
                            .attr("x1", -12)
                            .attr("y1", -10 + i * 8)
                            .attr("x2", 12)
                            .attr("y2", -10 + i * 8)
                            .attr("stroke", nodeColor)
                            .attr("stroke-width", 1);
                    }
                    break;
                case "temporal-region": // ‚ü∑ Temporal Region
                    group.append("line")
                        .attr("x1", -25)
                        .attr("y1", 0)
                        .attr("x2", 25)
                        .attr("y2", 0)
                        .attr("stroke", nodeColor)
                        .attr("stroke-width", strokeWidth);
                    // Add arrows on both ends
                    group.append("polygon")
                        .attr("points", "-25,0 -20,-5 -20,5")
                        .attr("fill", nodeColor);
                    group.append("polygon")
                        .attr("points", "25,0 20,-5 20,5")
                        .attr("fill", nodeColor);
                    break;
            }
        });

        // Add labels to node groups
        nodeGroup.append("text")
            .text(d => d.name)
            .attr("font-size", "9px")
            .attr("text-anchor", "middle")
            .attr("fill", "#f3f4f6")
            .attr("dy", "0.35em")
            .style("pointer-events", "none");

        // Enable dragging on nodes with proper event handling
        nodeGroup
            .style("cursor", "grab")
            .call(d3.drag()
                .on("start", function(event, d) {
                    if (!event.active) simulation.alphaTarget(0.3).restart();
                    d.fx = d.x;
                    d.fy = d.y;
                    d3.select(this).style("cursor", "grabbing");
                })
                .on("drag", function(event, d) {
                    d.fx = event.x;
                    d.fy = event.y;
                })
                .on("end", function(event, d) {
                    if (!event.active) simulation.alphaTarget(0);
                    d.fx = null;
                    d.fy = null;
                    d3.select(this).style("cursor", "grab");
                }));

        // Add relationship labels
        const linkLabels = g.append("g")
            .selectAll("text")
            .data(links)
            .join("text")
            .text(d => d.label)
            .attr("font-size", "8px")
            .attr("text-anchor", "middle")
            .attr("fill", "#cbd5e1")
            .attr("dy", "-2px")
            .style("pointer-events", "none");

        // Update positions on tick
        simulation.on("tick", () => {
            link
                .attr("x1", d => d.source.x)
                .attr("y1", d => d.source.y)
                .attr("x2", d => d.target.x)
                .attr("y2", d => d.target.y);

            nodeGroup
                .attr("transform", d => `translate(${d.x},${d.y})`);

            linkLabels
                .attr("x", d => (d.source.x + d.target.x) / 2)
                .attr("y", d => (d.source.y + d.target.y) / 2);
        });

        // Control buttons
        document.getElementById('reset-zoom').addEventListener('click', () => {
            svg.transition().duration(750).call(
                zoom.transform,
                d3.zoomIdentity
            );
        });

        document.getElementById('center-graph').addEventListener('click', () => {
            const bounds = g.node().getBBox();
            const centerX = bounds.x + bounds.width / 2;
            const centerY = bounds.y + bounds.height / 2;
            const scale = 0.9 / Math.max(bounds.width / width, bounds.height / height);
            const translate = [width / 2 - scale * centerX, height / 2 - scale * centerY];
            
            svg.transition().duration(750).call(
                zoom.transform,
                d3.zoomIdentity.translate(translate[0], translate[1]).scale(scale)
            );
        });

        // Drag functions
        function dragstarted(event, d) {
            if (!event.active) simulation.alphaTarget(0.3).restart();
            d.fx = d.x;
            d.fy = d.y;
        }

        function dragged(event, d) {
            d.fx = event.x;
            d.fy = event.y;
        }

        function dragended(event, d) {
            if (!event.active) simulation.alphaTarget(0);
            d.fx = null;
            d.fy = null;
        }

        // Make sure dragging is enabled on all node elements
        nodeGroup.selectAll("*").style("pointer-events", "all");

        // Add the SVG to the container
        container.appendChild(svg.node());
    </script>
</body>
</html>