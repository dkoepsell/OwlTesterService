<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BVSS Visualization - {{ file.original_filename }}</title>
    <link href="https://cdn.replit.com/agent/bootstrap-agent-dark-theme.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
</head>
<body>

<nav class="navbar navbar-expand-lg navbar-dark bg-dark">
    <div class="container-fluid">
        <a class="navbar-brand" href="/">
            <i class="fas fa-project-diagram me-2"></i>FOL-BFO-OWL Tester
        </a>
    </div>
</nav>
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                    <h2>BFO Visual Syntax System (BVSS)</h2>
                    <p class="text-muted">{{ file.original_filename }}</p>
                </div>
                <div>
                    <a href="{{ url_for('analyze_owl', filename=filename) }}" class="btn btn-secondary">
                        <i class="fas fa-arrow-left me-2"></i>Back to Analysis
                    </a>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-lg-9">
            <div class="card">
                <div class="card-header">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">Ontology Visualization</h5>
                        <div>
                            <button class="btn btn-sm btn-outline-primary" onclick="resetView()">Reset View</button>
                            <button class="btn btn-sm btn-outline-primary" onclick="centerGraph()">Center</button>
                        </div>
                    </div>
                </div>
                <div class="card-body p-0">
                    <div id="bvss-container" style="width: 100%; height: 700px; background: #1a1a1a;">
                        <svg id="bvss-svg" width="100%" height="100%"></svg>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-lg-3">
            <div class="card">
                <div class="card-header">
                    <h6 class="mb-0">BFO Visual Syntax Legend</h6>
                </div>
                <div class="card-body">
                    <div class="mb-4">
                        <h6 class="text-primary">Entity Types</h6>
                        <div class="legend-item mb-2">
                            <svg width="20" height="20" class="me-2">
                                <circle cx="10" cy="10" r="8" fill="#2563eb" stroke="#ffffff" stroke-width="2"/>
                            </svg>
                            <small><strong>●</strong> Independent Continuant</small>
                        </div>
                        <div class="legend-item mb-2">
                            <svg width="20" height="20" class="me-2">
                                <rect x="2" y="2" width="16" height="16" fill="#6b7280" stroke="#ffffff" stroke-width="2"/>
                            </svg>
                            <small><strong>■</strong> Material Entity</small>
                        </div>
                        <div class="legend-item mb-2">
                            <svg width="20" height="20" class="me-2">
                                <rect x="2" y="2" width="16" height="16" fill="none" stroke="#6b7280" stroke-width="2"/>
                            </svg>
                            <small><strong>□</strong> Immaterial Entity</small>
                        </div>
                        <div class="legend-item mb-2">
                            <svg width="20" height="20" class="me-2">
                                <circle cx="10" cy="10" r="8" fill="none" stroke="#dc2626" stroke-width="2" stroke-dasharray="4,2"/>
                            </svg>
                            <small><strong>◌</strong> Dependent Continuant</small>
                        </div>
                        <div class="legend-item mb-2">
                            <svg width="20" height="20" class="me-2">
                                <path d="M2,10 L18,10 M14,6 L18,10 L14,14" stroke="#059669" stroke-width="2" fill="none"/>
                            </svg>
                            <small><strong>⟶</strong> Process (Occurrent)</small>
                        </div>
                        <div class="legend-item mb-2">
                            <svg width="20" height="20" class="me-2">
                                <circle cx="10" cy="10" r="3" fill="#7c3aed"/>
                            </svg>
                            <small><strong>◦</strong> Quality</small>
                        </div>
                        <div class="legend-item mb-2">
                            <svg width="20" height="20" class="me-2">
                                <path d="M6,8 L10,4 L14,8 M8,10 L12,14 M10,4 L10,16" stroke="#ea580c" stroke-width="2" fill="none"/>
                            </svg>
                            <small><strong>⚒</strong> Function/Disposition</small>
                        </div>
                    </div>

                    <div class="mb-4">
                        <h6 class="text-success">Relations</h6>
                        <div class="legend-item mb-2">
                            <svg width="20" height="20" class="me-2">
                                <path d="M10,16 L10,4 M6,8 L10,4 L14,8" stroke="#3b82f6" stroke-width="2" fill="none"/>
                            </svg>
                            <small><strong>↑</strong> is_a (subsumption)</small>
                        </div>
                        <div class="legend-item mb-2">
                            <svg width="20" height="20" class="me-2">
                                <path d="M4,10 L16,10 M12,6 L16,10 L12,14" stroke="#9ca3af" stroke-width="2" stroke-dasharray="4,2" fill="none"/>
                            </svg>
                            <small><strong>→</strong> part_of</small>
                        </div>
                        <div class="legend-item mb-2">
                            <svg width="20" height="20" class="me-2">
                                <path d="M4,8 L16,8 M4,12 L16,12 M12,4 L16,8 L12,12" stroke="#10b981" stroke-width="2" fill="none"/>
                            </svg>
                            <small><strong>⇨</strong> participates_in</small>
                        </div>
                        <div class="legend-item mb-2">
                            <svg width="20" height="20" class="me-2">
                                <path d="M4,10 L16,10 M12,6 L16,10 L12,14" stroke="#f59e0b" stroke-width="1" fill="none"/>
                            </svg>
                            <small><strong>→</strong> inheres_in</small>
                        </div>
                    </div>

                    <div>
                        <h6 class="text-info">Statistics</h6>
                        <p class="small mb-1">Classes: <span id="class-count">0</span></p>
                        <p class="small mb-1">Properties: <span id="property-count">0</span></p>
                        <p class="small mb-0">Relations: <span id="relation-count">0</span></p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://d3js.org/d3.v7.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Get visualization data
    fetch('/api/bvss/{{ filename }}')
        .then(response => response.json())
        .then(data => {
            console.log('BVSS data received:', data);
            createBVSSVisualization(data);
        })
        .catch(error => {
            console.error('Error loading BVSS data:', error);
            document.getElementById('bvss-svg').innerHTML = '<text x="50%" y="50%" text-anchor="middle" fill="white" font-size="16">Error loading visualization data</text>';
        });

    function createBVSSVisualization(data) {
        const classes = data.classes || [];
        const properties = data.properties || [];
        const inheritance = data.inheritance || [];
        
        // Update counts
        document.getElementById('class-count').textContent = classes.length;
        document.getElementById('property-count').textContent = properties.length;
        document.getElementById('relation-count').textContent = inheritance.length;

        const svg = d3.select('#bvss-svg');
        svg.selectAll('*').remove();
        
        const container = svg.append('g');
        const width = 800;
        const height = 700;

        // Create zoom behavior
        const zoom = d3.zoom()
            .scaleExtent([0.1, 4])
            .on('zoom', function(event) {
                container.attr('transform', event.transform);
            });

        svg.call(zoom);

        // Define markers for arrows
        const defs = svg.append('defs');
        
        // Subsumption arrow (is_a)
        defs.append('marker')
            .attr('id', 'subsumption')
            .attr('viewBox', '0 -5 10 10')
            .attr('refX', 20)
            .attr('refY', 0)
            .attr('markerWidth', 8)
            .attr('markerHeight', 8)
            .attr('orient', 'auto')
            .append('path')
            .attr('d', 'M0,-5L10,0L0,5')
            .attr('fill', '#3b82f6');

        // Part-of arrow (dashed)
        defs.append('marker')
            .attr('id', 'part-of')
            .attr('viewBox', '0 -5 10 10')
            .attr('refX', 20)
            .attr('refY', 0)
            .attr('markerWidth', 8)
            .attr('markerHeight', 8)
            .attr('orient', 'auto')
            .append('path')
            .attr('d', 'M0,-5L10,0L0,5')
            .attr('fill', '#9ca3af');

        // Prepare nodes
        const nodes = [];
        
        // Add class nodes
        classes.forEach(cls => {
            nodes.push({
                id: cls.id,
                name: cls.name,
                type: 'class',
                bfoType: classifyBFOType(cls.name),
                x: Math.random() * (width - 200) + 100,
                y: Math.random() * (height - 200) + 100
            });
        });

        // Add property nodes
        properties.forEach(prop => {
            nodes.push({
                id: prop.id,
                name: prop.name,
                type: 'property',
                bfoType: 'relation',
                x: Math.random() * (width - 200) + 100,
                y: Math.random() * (height - 200) + 100
            });
        });

        // Prepare edges
        const edges = inheritance.map(edge => ({
            source: edge.source,
            target: edge.target,
            type: 'subsumption'
        }));

        // Create force simulation
        const simulation = d3.forceSimulation(nodes)
            .force('link', d3.forceLink(edges).id(d => d.id).distance(120))
            .force('charge', d3.forceManyBody().strength(-400))
            .force('center', d3.forceCenter(width / 2, height / 2))
            .force('collision', d3.forceCollide().radius(40));

        // Create links
        const link = container.append('g')
            .selectAll('line')
            .data(edges)
            .enter().append('line')
            .attr('class', 'link')
            .attr('stroke', d => d.type === 'subsumption' ? '#3b82f6' : '#9ca3af')
            .attr('stroke-width', 2)
            .attr('stroke-dasharray', d => d.type === 'part-of' ? '5,5' : null)
            .attr('marker-end', d => `url(#${d.type === 'subsumption' ? 'subsumption' : 'part-of'})`);

        // Create node groups
        const node = container.append('g')
            .selectAll('.node')
            .data(nodes)
            .enter().append('g')
            .attr('class', 'node')
            .style('cursor', 'pointer')
            .call(d3.drag()
                .on('start', dragstarted)
                .on('drag', dragged)
                .on('end', dragended));

        // Add BVSS symbols
        node.each(function(d) {
            const g = d3.select(this);
            
            switch(d.bfoType) {
                case 'independent-continuant':
                    // Solid circle ●
                    g.append('circle')
                        .attr('r', 20)
                        .attr('fill', '#2563eb')
                        .attr('stroke', '#ffffff')
                        .attr('stroke-width', 2);
                    break;
                    
                case 'material-entity':
                    // Filled square ■
                    g.append('rect')
                        .attr('x', -15)
                        .attr('y', -15)
                        .attr('width', 30)
                        .attr('height', 30)
                        .attr('fill', '#6b7280')
                        .attr('stroke', '#ffffff')
                        .attr('stroke-width', 2);
                    break;
                    
                case 'dependent-continuant':
                    // Dashed circle ◌
                    g.append('circle')
                        .attr('r', 20)
                        .attr('fill', 'none')
                        .attr('stroke', '#dc2626')
                        .attr('stroke-width', 2)
                        .attr('stroke-dasharray', '4,2');
                    break;
                    
                case 'process':
                    // Arrow ⟶
                    g.append('path')
                        .attr('d', 'M-20,0 L20,0 M15,-5 L20,0 L15,5')
                        .attr('stroke', '#059669')
                        .attr('stroke-width', 3)
                        .attr('fill', 'none');
                    break;
                    
                case 'quality':
                    // Small dot ◦
                    g.append('circle')
                        .attr('r', 8)
                        .attr('fill', '#7c3aed');
                    break;
                    
                case 'function':
                    // Hammer symbol ⚒
                    g.append('path')
                        .attr('d', 'M-10,-5 L0,-15 L10,-5 M-5,0 L5,10 M0,-15 L0,15')
                        .attr('stroke', '#ea580c')
                        .attr('stroke-width', 2)
                        .attr('fill', 'none');
                    break;
                    
                case 'relation':
                    // Diamond for properties
                    g.append('path')
                        .attr('d', 'M0,-15 L15,0 L0,15 L-15,0 Z')
                        .attr('fill', '#f59e0b')
                        .attr('stroke', '#ffffff')
                        .attr('stroke-width', 2);
                    break;
                    
                default:
                    // Default circle
                    g.append('circle')
                        .attr('r', 20)
                        .attr('fill', '#4b5563')
                        .attr('stroke', '#ffffff')
                        .attr('stroke-width', 2);
            }
        });

        // Add labels
        node.append('text')
            .attr('dy', 35)
            .attr('text-anchor', 'middle')
            .attr('fill', '#ffffff')
            .attr('font-size', '12px')
            .attr('font-weight', 'bold')
            .text(d => d.name);

        // Add tooltips
        node.append('title')
            .text(d => `${d.name}\nType: ${d.bfoType}\nCategory: ${d.type}`);

        // Update positions on tick
        simulation.on('tick', function() {
            link
                .attr('x1', d => d.source.x)
                .attr('y1', d => d.source.y)
                .attr('x2', d => d.target.x)
                .attr('y2', d => d.target.y);

            node
                .attr('transform', d => `translate(${d.x},${d.y})`);
        });

        // Drag functions
        function dragstarted(event, d) {
            if (!event.active) simulation.alphaTarget(0.3).restart();
            d.fx = d.x;
            d.fy = d.y;
        }

        function dragged(event, d) {
            d.fx = event.x;
            d.fy = event.y;
        }

        function dragended(event, d) {
            if (!event.active) simulation.alphaTarget(0);
            d.fx = null;
            d.fy = null;
        }
    }

    // Global functions for controls
    window.resetView = function() {
        const svg = d3.select('#bvss-svg');
        const zoom = d3.zoom().scaleExtent([0.1, 4]);
        svg.transition().duration(750).call(
            zoom.transform,
            d3.zoomIdentity
        );
    };

    window.centerGraph = function() {
        const svg = d3.select('#bvss-svg');
        const container = svg.select('g');
        if (container.empty()) return;
        
        const bounds = container.node().getBBox();
        const fullWidth = svg.node().clientWidth;
        const fullHeight = svg.node().clientHeight;
        const width = bounds.width;
        const height = bounds.height;
        const midX = bounds.x + width / 2;
        const midY = bounds.y + height / 2;
        
        const scale = Math.min(fullWidth / width, fullHeight / height) * 0.8;
        const translate = [fullWidth / 2 - scale * midX, fullHeight / 2 - scale * midY];
        
        const zoom = d3.zoom().scaleExtent([0.1, 4]);
        svg.transition().duration(750).call(
            zoom.transform,
            d3.zoomIdentity.translate(translate[0], translate[1]).scale(scale)
        );
    };

    function classifyBFOType(className) {
        const name = className.toLowerCase();
        
        // Legal domain classification
        if (name.includes('agent') || name.includes('person') || name.includes('court')) {
            return 'independent-continuant';
        }
        if (name.includes('document') || name.includes('evidence') || name.includes('statute')) {
            return 'material-entity';
        }
        if (name.includes('role') || name.includes('right') || name.includes('obligation')) {
            return 'dependent-continuant';
        }
        if (name.includes('trial') || name.includes('process') || name.includes('adjudication')) {
            return 'process';
        }
        if (name.includes('jurisdiction') || name.includes('authority')) {
            return 'function';
        }
        
        // Default classification
        return 'independent-continuant';
    }
});
</script>

<style>
.legend-item {
    display: flex;
    align-items: center;
}

.node {
    transition: all 0.3s ease;
}

.node:hover {
    filter: brightness(1.2);
}

.link {
    transition: all 0.3s ease;
}

.link:hover {
    stroke-width: 3;
}

#bvss-container {
    border: 1px solid #374151;
    border-radius: 8px;
}
</style>
</div>
</body>
</html>